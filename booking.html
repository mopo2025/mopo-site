<!doctype html>
<html lang="zh-Hant">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=AW-17610938726"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'AW-17610938726');
</script>
  
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Content Security Policy：嚴格、可在 localhost/部署下使用 -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline' https://www.gstatic.com https://script.google.com https://script.googleusercontent.com;
  style-src 'self' 'unsafe-inline';
  img-src 'self' https://images.unsplash.com data:;
  connect-src 'self' https://api.moposki.com;
  base-uri 'self';
  frame-ancestors 'none';
  form-action 'self';
  upgrade-insecure-requests;
">

<title>MOPO 訂課預約申請</title>
<style>
  :root{
    --bg:#f6f7f6; --ink:#0f172a; --muted:#5b6b73;
    --brand:#0ea5e9; --heading:#0b5d45;
    --card:#ffffff; --ring:rgba(14,165,233,.25);
    --radius:18px; --rule:#e1e6e9; --rule-strong:#c8d1d6;
    --ctrl-max:520px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial}
  .wrap{max-width:980px;margin:28px auto;padding:0 18px}
  h1{margin:0 0 6px;font-weight:800;letter-spacing:.2px;color:var(--heading)}
  .muted{color:var(--muted)}
  .card{background:var(--card);border:1px solid var(--rule);border-radius:var(--radius);box-shadow:0 1px 2px rgba(0,0,0,.04);padding:18px;margin:16px 0}
  .kicker{display:block;color:#648d86;letter-spacing:.18em;font-weight:800;font-size:.72rem;margin-bottom:6px}
  h2{margin:0 0 12px;font-size:1.24rem;font-weight:800;letter-spacing:.02em}
  .rule{height:2px;background:var(--rule-strong);margin:12px 0}

  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .langBtns{display:flex;gap:8px}
  .langBtns button{border:1px solid #d1d5db;background:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
  .langBtns button.active{background:var(--brand);color:#fff;border-color:transparent}
  .langSel{display:none}
  @media (max-width:640px){
    .langBtns{display:none}
    .langSel{display:block}
  }
  .langSel select{
    padding:8px 12px;border-radius:10px;border:1px solid #d1d5db;background:#fff;min-height:40px;font-size:.95rem;
  }

  .grid{display:grid;gap:14px}
  .choices-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .choices-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:860px){.choices-3,.choices-2{grid-template-columns:1fr}}
  .choice{position:relative;display:grid;place-items:center;gap:10px;padding:18px;border-radius:16px;border:2px solid transparent;background:#fff;cursor:pointer;transition:.2s}
  .choice:hover{border-color:var(--ring);box-shadow:0 0 0 6px var(--ring)}
  .choice.active{border-color:var(--brand)}
  .choice img{width:100%;height:160px;object-fit:cover;border-radius:12px}
  .choice .title{font-weight:900;font-size:1.22rem;letter-spacing:.01em}
  .choice .sub{color:var(--muted)}
  .discipline .title{font-size:1.26rem}

  .discipline .media{
    aspect-ratio: 4/3;
    width: clamp(240px, 28vw, 360px);
    border-radius: 12px;
    overflow: hidden;
    background:#f3f4f6;
    display:grid;
    place-items:center;
  }
  .discipline .media img{ width:100%; height:100%; object-fit:cover; }
  .discipline .media[data-fit="contain"] img{ object-fit:contain; background:#fff; }
  @media (max-width:860px){ .discipline .media{ width:100%; } }

  .choice.disabled{filter:grayscale(1) brightness(.9); cursor:not-allowed; border-color:#e5e7eb}
  .choice.disabled:hover{box-shadow:none; border-color:#e5e7eb}
  .choice.disabled .badge{background:#0f172a; color:#fff; opacity:.9}
  .badge{position:absolute;top:10px;left:10px;font-size:.78rem;padding:4px 8px;border-radius:999px;background:#f1f5f9;color:#111}

  .field{display:grid;gap:6px;margin:12px 0; max-width:var(--ctrl-max)}
  label{font-weight:700;font-size:1.02rem;letter-spacing:.01em}
  select, input[type="text"], input[type="email"], input[type="date"], textarea{
    width:100%; padding:14px 14px; border-radius:12px; border:1px solid #d1d5db; background:#fff;
    font-size:1.05rem; line-height:1.35; min-height:50px;
  }
  input[type="date"]{ overflow:clip; text-overflow:ellipsis; position:relative; }
  @supports (-webkit-touch-callout: none) { input[type="date"]{ padding-right:36px } }
  textarea{min-height:110px;resize:vertical}
  .note{font-size:.92rem;color:#5b6b73;margin-top:6px}
  .price{font-weight:800;margin-top:8px}
  .hide{display:none}

  .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;transition:.2s}
  .btn.primary{background:var(--brand);color:#fff;border-color:transparent}
  .btn.full{width:100%}
  .row-actions{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}

  .checkline{position:relative;display:flex;align-items:flex-start;gap:10px;flex-wrap:wrap;margin-top:12px}
  .checkline input[type="checkbox"]{margin-top:4px;flex-shrink:0}
  .checkline label{line-height:1.55;margin:0}
  .checkline a{color:#0369a1;text-decoration:underline;white-space:nowrap}

  .modal{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:16px}
  .modal .panel{background:#fff;max-width:720px;width:100%;border-radius:16px;padding:18px;border:1px solid #e5e7eb}
  .modal h3{margin:0 0 8px;font-size:1.12rem}
  .dt{color:#64748b;font-size:.9rem;margin-bottom:8px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:10px;margin:8px 0}
  .kv b{font-weight:700}

  @media (min-width: 861px) {
    #step3 #details, #step3 #addonRow { display:grid; justify-items:center; }
    #step3 .field, #step3 .checkline, #step3 .row-actions, #step3 #priceBox, #step3 #seasonNote {
      margin-left:auto; margin-right:auto; width:100%; max-width:var(--ctrl-max);
    }
  }
  .price-old{ text-decoration: line-through; color:#64748b; margin-right:6px; }
  .price-new{ color:#dc2626; font-weight:800; }
</style>
</head>
<body>
<div class="wrap" id="app">
  <div class="topbar">
    <div>
      <span class="kicker" data-i="kicker">RESERVATION</span>
      <h1 data-i="title">MOPO 訂課預約申請</h1>
      <p class="muted" data-i="intro">依序完成 3 個步驟即可送出選單。</p>
    </div>
    <div class="langBtns" aria-label="Language buttons">
      <button data-lang="zh-Hant" class="active">繁中</button>
      <button data-lang="en">EN</button>
      <button data-lang="ja">日本語</button>
    </div>
    <div class="langSel" aria-label="Language select">
      <select id="langSelect">
        <option value="zh-Hant" selected>繁中</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
      </select>
    </div>
  </div>

  <div class="card" id="step1">
    <span class="kicker" data-i="s1">STEP 1</span>
    <h2 data-i="s1t">選擇滑雪場地點</h2>
    <div class="rule"></div>
    <div class="grid choices-3" id="resortChoices">
      <button type="button" class="choice" data-resort="teine">
        <img src="img/news/teine.jpg" alt="Teine">
        <span class="badge" data-i="badge_coming" style="display:none">即將開放</span>
        <div class="title" data-i="r_teine">手稻｜私人課（全日）</div>
        <div class="sub" data-i="r_teine_sub">雪質與交通最便利</div>
      </button>
      <button type="button" class="choice" data-resort="onze">
        <img src="img/news/onze.png" alt="ONZE">
        <span class="badge" data-i="badge_coming" style="display:none">即將開放</span>
        <div class="title" data-i="r_onze">ONZE｜私人課（全日）</div>
        <div class="sub" data-i="r_onze_sub">臨海絕景・交通便利</div>
      </button>
      <button type="button" class="choice" data-resort="kokusai">
        <img src="img/news/kokusai.jpg" alt="Kokusai">
        <span class="badge" data-i="badge_coming" style="display:none">即將開放</span>
        <div class="title" data-i="r_koku">札幌國際｜私人課（全日）</div>
        <div class="sub" data-i="r_koku_sub">視野開闊・多樣路線</div>
      </button>
    </div>
  </div>

  <div class="card hide" id="step2">
    <span class="kicker" data-i="s2">STEP 2</span>
    <h2 data-i="s2t">選擇課程類別</h2>
    <div class="rule"></div>
    <div class="grid choices-2 discipline" id="disciplineChoices">
      <button type="button" class="choice" data-type="snowboard">
        <div class="media"><img src="img/booking/snowboard.jpg" alt="Snowboard"></div>
        <div class="title" data-i="snow">單板 Snowboard</div>
      </button>
      <button type="button" class="choice" data-type="ski">
        <div class="media"><img src="img/booking/ski.jpg" alt="Ski"></div>
        <div class="title" data-i="ski">雙板 Ski</div>
      </button>
    </div>
  </div>

  <div class="card hide" id="step3">
    <span class="kicker" data-i="s3">STEP 3</span>
    <h2 data-i="s3t">選擇產品與詳細</h2>
    <div class="rule"></div>

    <div id="productHeader" style="font-weight:900;font-size:1.12rem;letter-spacing:.01em;margin:2px 0 10px;">
      <span data-i="prod6h">全日 6 小時課程</span>
    </div>

    <div id="details" class="hide">
      <div class="field">
        <label data-i="date_label">日期</label>
        <input type="date" id="date" min="2025-12-06" max="2026-04-20" required />
        <div class="note" id="dateWarn" style="display:none"></div>
      </div>

      <div class="field">
        <label data-i="days_label">上課天數</label>
        <select id="days"></select>
        <div class="note" data-i="days_note">＊若選多天，我們會依實際可排程日期與您確認</div>
      </div>

      <div class="field">
        <label data-i="people_label">上課人數</label>
        <select id="people"></select>
      </div>

      <div class="field">
        <label data-i="level_label">滑行程度</label>
        <select id="level"></select>
      </div>

      <div class="field">
        <label data-i="name_label">稱呼（選填）</label>
        <input type="text" id="name" placeholder="暱稱或名字即可" />
      </div>

      <div class="field">
        <label data-i="kid_age_label">小朋友年齡（非必填）</label>
        <input type="text" id="kidAge" inputmode="numeric" placeholder="" />
        <div class="note" data-i="kid_age_note">可填 1–12；多人請以逗號分隔（例：6, 8）。</div>
      </div>

      <div class="field">
        <label data-i="email_label">Email（必填）</label>
        <input type="email" id="email" autocomplete="email" required />
      </div>

      <div class="field">
        <label data-i="contact_pref_label">偏好聯絡管道</label>
        <select id="contactPref">
          <option value="line" data-i="pref_line">LINE</option>
          <option value="wechat" data-i="pref_wechat">WeChat</option>
          <option value="whatsapp" data-i="pref_whatsapp">WhatsApp</option>
          <option value="email" data-i="pref_email">Email</option>
          <option value="other" data-i="pref_other">其他</option>
        </select>
      </div>

      <div class="field">
        <label id="contactIdLabel" data-i="contact_id_label">聯絡帳號</label>
        <input type="text" id="contactId" placeholder="" />
      </div>

      <div class="field">
        <label data-i="lang_label">上課語言</label>
        <select id="lang"></select>
      </div>

      <div class="field">
        <label data-i="memo_label">備註</label>
        <textarea id="memo" placeholder=""></textarea>
      </div>

      <div class="field">
        <label data-i="qty_label">數量</label>
        <select id="qty"><option value="1">1</option><option value="2">2</option></select>
        <div class="note" data-i="qty_note">＊數量指同一組條件的預約筆數（例：兩位教練兩組並行）。</div>
      </div>

      <div class="field" id="addonRow">
        <label><input type="checkbox" id="addon1h">
          <span data-i="addon_txt">＋1 時間追加（通常 ¥16,000｜繁忙期 ¥18,000）</span>
        </label>
      </div>

      <p class="price" id="priceBox"></p>
      <p class="muted" id="seasonNote"></p>

      <div class="checkline">
        <input type="checkbox" id="agreeNotice" />
        <label for="agreeNotice">
          <span data-i="agree_prefix">我已閱讀並同意 </span>
          <a id="noticeLink" href="/notice.html" target="_blank" rel="noopener" data-i="notice_title">《課程注意事項》</a>
          <span data-i="agree_suffix"></span>
        </label>
      </div>

      <div class="row-actions">
        <button class="btn primary" id="sendBtn" type="button" data-i="sendmenu">送出選單</button>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="panel">
    <h3 data-i="review_title">請確認您的預約明細</h3>
    <div class="dt" data-i="review_hint">確認無誤後按「送出」完成申請。</div>
    <div id="reviewList"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px">
      <button class="btn" id="backBtn" data-i="back_edit">返回修改</button>
      <button class="btn primary" id="submitBtn" data-i="submit">送出</button>
    </div>
  </div>
</div>

<script>
  /********** 設定區 **********/
 // 雪場開啟設定：true = 開放、false = 關閉
const RESORT_AVAIL = { 
  teine:   true,  // 手稻 Teine
  onze:    true,  // ONZE
  kokusai: true   // 札幌國際 Kokusai
};

// 9/15 預購開放（指定年版）
const PREORDER_OPEN_AT = '2025-09-15T00:00:00+09:00'; // 日本時間
function isPreorderOpenNow(){
  return Date.now() >= new Date(PREORDER_OPEN_AT).getTime();
}
  const DATE_MIN='2025-12-06', DATE_MAX='2026-04-20';
  const peakRanges=[{start:'2025-12-20',end:'2026-01-11'},{start:'2026-02-12',end:'2026-02-22'},{start:'2026-02-27',end:'2026-03-01'}];
  const priceMap={
    teine:{off:{base:{1:72000,2:77000,3:82000,4:87000},extra5:5000},peak:{base:{1:82000,2:87000,3:92000,4:97000},extra5:5000}},
    onze:{ off:{base:{1:72000,2:77000,3:82000,4:87000},extra5:5000},peak:{base:{1:82000,2:87000,3:92000,4:97000},extra5:5000}},
    kokusai:{off:{base:{1:84000,2:90000,3:96000,4:102000},extra5:6000},peak:{base:{1:94000,2:100000,3:106000,4:112000},extra5:6000}}
  };
  const ADDON_1H={off:16000, peak:18000};

  const EARLY_BIRD_DEADLINE = '2025-11-01T01:00:00+09:00';
  const EARLY_BIRD_AMOUNT   = 2000;
  function isEarlyBirdNow(){ return Date.now() <= new Date(EARLY_BIRD_DEADLINE).getTime(); }

  // 換成你的實際 換去Worker
const API_URL = 'https://api.moposki.com';

  /* i18n（保留原內容） */
  const I18N={ /* --- 你的原始 I18N 物件，完整無改動 --- */ 
    'zh-Hant':{kicker:'RESERVATION',title:'MOPO 訂課預約',intro:'依序完成 3 個步驟即可送出選單。',
      s1:'STEP 1',s1t:'選擇滑雪場地點',s2:'STEP 2',s2t:'選擇課程類別',s3:'STEP 3',s3t:'選擇產品與詳細',
      r_teine:'手稻｜私人課（全日）', r_teine_sub:'雪質與交通穩定',
      r_onze:'ONZE｜私人課（全日）', r_onze_sub:'臨海絕景・交通便利',
      r_koku:'札幌國際｜私人課（全日）', r_koku_sub:'視野開闊・多樣路線',
      ski:'雙板 Ski', snow:'單板 Snowboard',
      prod6h:'全日 6 小時課程', tap_to_config:'點選以設定細節',
      addon_txt:'＋1 時間追加（通常 ¥16,000｜繁忙期 ¥18,000）',
      date_label:'日期', days_label:'上課天數', days_note:'＊若選多天，我們會依實際可排程日期與您確認',
      people_label:'上課人數', level_label:'滑行程度', name_label:'稱呼',
      kid_age_label:'小朋友年齡（非必填）', kid_age_note:'可填 1–12；多人請以逗號分隔（例：6, 8）。',
      email_label:'Email（必填）',
      contact_pref_label:'偏好聯絡管道',
      pref_line:'LINE', pref_wechat:'WeChat', pref_whatsapp:'WhatsApp', pref_email:'Email', pref_other:'其他',
      contact_id_label:'聯絡帳號', lang_label:'上課語言', memo_label:'備註',
      qty_label:'數量', qty_note:'＊數量指同一組條件的預約筆數（例：兩位教練兩組並行）。',
      agree_prefix:'我已閱讀並同意 ', notice_title:'《課程注意事項》', agree_suffix:'',
      sendmenu:'送出選單',
      review_title:'請確認您的預約明細', review_hint:'確認無誤後按「送出」完成申請。',
      back_edit:'返回修改', submit:'送出',
      season_off:'除繁忙期外，其他時段適用標準價格。',
      badge_coming:'即將開放',
      success:'已送出，我們將盡快與您聯絡。回覆可能需要 1～3 個工作日，會盡快為您處理訂單。謝謝您的預訂。',
      levels:[
        '完全初學：第一次滑雪','新手：曾有過一點經驗','初級：可滑行於初級雪道',
        '中階：能滑行於中級雪道','進階：中級雪道流暢，進修高級雪道',
        '高階：進階技巧練習（滑行粉雪・樹林・跳台等）'
      ],
      langs:[
        '偏好中文','偏好英文','偏好日文','偏好廣東話（中或英文可）','只接受英文','只接受廣東話'
      ],
      people_opts:['1','2','3','4','5'], days_opts:['1','2','3','4','5','6','7','8','9','10']
    },
    'en':{kicker:'RESERVATION',title:'MOPO Lesson Booking',intro:'Complete the 3 steps to send your selection.',
      s1:'STEP 1',s1t:'Choose Resort',s2:'STEP 2',s2t:'Choose Discipline',s3:'STEP 3',s3t:'Product & Details',
      r_teine:'Teine｜Private (Full day)', r_teine_sub:'Reliable snow & access',
      r_onze:'ONZE｜Private (Full day)', r_onze_sub:'Sea view & easy access',
      r_koku:'Sapporo Kokusai｜Private (Full day)', r_koku_sub:'Open view, varied runs',
      ski:'Ski', snow:'Snowboard', prod6h:'Full-day 6h Lesson', tap_to_config:'Tap to configure',
      addon_txt:'+1h add-on (Off-peak ¥16,000｜Peak ¥18,000)',
      date_label:'Date', days_label:'Number of Days', days_note:'* For multi-day bookings we will confirm actual schedule with you.',
      people_label:'Group Size', level_label:'Ability Level', name_label:'Your Name (optional)',
      kid_age_label:'Child age (optional)', kid_age_note:'Enter 1–12; multiple children separated by commas (e.g., 6, 8).',
      email_label:'Email (required)', contact_pref_label:'Preferred contact',
      pref_line:'LINE', pref_wechat:'WeChat', pref_whatsapp:'WhatsApp', pref_email:'Email', pref_other:'Other',
      contact_id_label:'Contact ID', lang_label:'Lesson Language', memo_label:'Notes',
      qty_label:'Quantity', qty_note:'* Quantity = identical bookings (e.g., two instructors in parallel).',
      agree_prefix:'I have read and agree to ', notice_title:'“Lesson Notice”', agree_suffix:'',
      sendmenu:'Send Selection', review_title:'Review Your Booking', review_hint:'Press “Submit” to finish.',
      back_edit:'Back to Edit', submit:'Submit', season_off:'Off-peak pricing applies.',
      badge_coming:'Coming soon',
      success:'Submitted! We will contact you shortly. Replies may take 1–3 business days.',
      levels:['First timer','Beginner: a little experience','Novice: green slopes','Intermediate: blue slopes','Advanced: fluent on blue, stepping into black','Expert: powder/trees/jumps training'],
      langs:['Prefer English','Prefer Chinese','Prefer Japanese','Prefer Cantonese (CN/EN OK)','English only','Cantonese only'],
      people_opts:['1','2','3','4','5'], days_opts:['1','2','3','4','5','6','7','8','9','10']
    },
    'ja':{kicker:'RESERVATION',title:'MOPO レッスン予約',intro:'3ステップで選択内容を送信。',
      s1:'STEP 1',s1t:'スキー場を選択',s2:'STEP 2',s2t:'種目を選択',s3:'STEP 3',s3t:'商品と詳細',
      r_teine:'手稲｜プライベート（終日）', r_teine_sub:'安定した雪質・アクセス',
      r_onze:'ONZE｜プライベート（終日）', r_onze_sub:'海景・アクセス良好',
      r_koku:'札幌国際｜プライベート（終日）', r_koku_sub:'開放的な景色・多彩なコース',
      ski:'スキー', snow:'スノーボード', prod6h:'終日 6 時間レッスン', tap_to_config:'タップして詳細を設定',
      addon_txt:'+1 時間追加（通常 ¥16,000｜繁忙期 ¥18,000）',
      date_label:'日付', days_label:'受講日数', days_note:'※複数日の場合、実際のスケジュールを確認します。',
      people_label:'人数', level_label:'レベル', name_label:'お名前（任意）',
      kid_age_label:'お子さまの年齢（任意）', kid_age_note:'1～12 を入力。複数はカンマ区切り（例：6, 8）',
      email_label:'メール（必須）', contact_pref_label:'連絡方法の希望',
      pref_line:'LINE', pref_wechat:'WeChat', pref_whatsapp:'WhatsApp', pref_email:'メール', pref_other:'その他',
      contact_id_label:'連絡アカウント', lang_label:'受講言語', memo_label:'備考',
      qty_label:'数量', qty_note:'※同一条件の予約件数（例：講師2名で同時進行）',
      agree_prefix:'『', notice_title:'受講注意事項', agree_suffix:'』を読み、同意します。',
      sendmenu:'選択内容を送信', review_title:'予約内容の確認', review_hint:'問題なければ「送信」。',
      back_edit:'修正に戻る', submit:'送信', season_off:'繁忙期以外は通常料金が適用されます。',
      badge_coming:'近日公開',
      success:'送信しました。折り返しに 1～3 営業日いただく場合があります。',
      levels:['完全初心者：初めて','初級手前：少し経験あり','初級：初級コース可','中級：中級コース可','上級手前：中級は余裕・上級に挑戦','上級：パウダー・ツリー・ジャンプ等'],
      langs:['日本語希望','中国語希望','英語希望','広東語希望（中/英 可）','英語のみ','広東語のみ'],
      people_opts:['1','2','3','4','5'], days_opts:['1','2','3','4','5','6','7','8','9','10']
    }
  };

  /********** 小工具 **********/
  const $=(q,r=document)=>r.querySelector(q);
  const $$=(q,r=document)=>Array.from(r.querySelectorAll(q));
  const money=n=>`¥${Number(n).toLocaleString()}`;
  const isPeak=d=>{const t=new Date(d).getTime(); return peakRanges.some(({start,end})=> t>=new Date(start).getTime() && t<=new Date(end).getTime());};
  const inDateRange=d=>{const t=new Date(d).getTime(); return t>=new Date(DATE_MIN).getTime() && t<=new Date(DATE_MAX).getTime();};
  const mapNotice=lang=>({ 'zh-Hant':'/notice.html','en':'/en_notice.html','ja':'/ja_notice.html' }[lang]||'/notice.html');

  function normalizeNumber(val, min=1, max=10){
    let n = parseInt(val, 10);
    if (isNaN(n)) n = min;
    if (n < min) n = min;
    if (n > max) n = max;
    return n;
  }

  /********** 狀態 **********/
  let current={resort:null,type:null,lang:'zh-Hant'};

  const dateInput=$('#date'), peopleSel=$('#people'), daysSel=$('#days'), qtySel=$('#qty');
  const levelSel=$('#level'), addon1h=$('#addon1h'), priceBox=$('#priceBox'), seasonNote=$('#seasonNote');
  const dateWarn=$('#dateWarn');

  const emailInput = $('#email');
  const contactPrefSel = $('#contactPref');
  const contactIdInput = $('#contactId');
  const contactIdLabel = $('#contactIdLabel');

  /********** 語言套用 **********/
  function fillOptions(){
    const L=I18N[current.lang];
    daysSel.innerHTML=L.days_opts.map(n=>`<option>${n}</option>`).join('');
    peopleSel.innerHTML=L.people_opts.map(n=>`<option>${n}</option>`).join('');
    levelSel.innerHTML=L.levels.map(s=>`<option>${s}</option>`).join('');
    $('#lang').innerHTML=L.langs.map(s=>`<option>${s}</option>`).join('');
  }

  const CONTACT_PLACEHOLDERS = {
    line:{ zh:'請輸入 LINE ID', en:'Enter LINE ID', ja:'LINE ID を入力' },
    wechat:{ zh:'請輸入 WeChat ID', en:'Enter WeChat ID', ja:'WeChat ID を入力' },
    whatsapp:{ zh:'請輸入 WhatsApp 帳號或電話', en:'Enter WhatsApp account/number', ja:'WhatsApp アカウント/番号' },
    email:{ zh:'若選 Email，將以此 Email 聯絡', en:'We will use your email', ja:'メールでご連絡します' },
    other:{ zh:'請輸入可聯絡的帳號', en:'Enter a reachable contact', ja:'連絡可能なアカウントを入力' }
  };
  function applyContactPlaceholder(){
    if(!contactPrefSel || !contactIdInput) return;
    const m = contactPrefSel.value || 'line';
    const lang = (current.lang==='ja'?'ja':(current.lang==='en'?'en':'zh'));
    contactIdLabel.textContent = I18N[current.lang].contact_id_label || (lang==='zh'?'聯絡帳號':(lang==='en'?'Contact ID':'連絡アカウント'));
    contactIdInput.placeholder = CONTACT_PLACEHOLDERS[m][lang];
  }

  function applyI18n(){
    const L=I18N[current.lang];
    $$('[data-i]').forEach(el=>{
      const key=el.getAttribute('data-i');
      if(key in L) el.innerHTML=L[key];
    });
    $$('#resortChoices .choice .badge').forEach(b=> b.textContent = L.badge_coming);
    $('#noticeLink').href=mapNotice(current.lang);
    fillOptions(); updatePrice(); applyContactPlaceholder();
    dateWarn.textContent = (current.lang==='en') ? `Only ${DATE_MIN}–${DATE_MAX} are available.` :
                          (current.lang==='ja') ? `予約可能期間は ${DATE_MIN}〜${DATE_MAX} です。` :
                                                  `可預約期間：${DATE_MIN}～${DATE_MAX}`;
  }
  function setLang(lang){
    current.lang=lang;
    document.documentElement.lang=lang;
    $$('.langBtns button').forEach(x=>x.classList.toggle('active', x.dataset.lang===lang));
    const sel=$('#langSelect'); if(sel) sel.value=lang;
    applyI18n();
  }
  $$('.langBtns button').forEach(b=> b.addEventListener('click',()=>setLang(b.dataset.lang)));
  $('#langSelect').addEventListener('change',e=> setLang(e.target.value));
  contactPrefSel?.addEventListener('change', applyContactPlaceholder);

  /********** 雪場開關 **********/
 function applyResortAvailability(){
  const openAll = isPreorderOpenNow(); // 到 9/15 後全部開放

  $$('#resortChoices .choice').forEach(btn=>{
    const key = btn.dataset.resort;

    // 若開放預購 → 全部可點；否則依原本 RESORT_AVAIL
    const open = openAll ? true : !!RESORT_AVAIL[key];

    btn.classList.toggle('disabled', !open);
    btn.setAttribute('aria-disabled', String(!open));

    const badge = $('.badge', btn);
    if (badge) {
      if (!open) {
        // 尚未開放 → 顯示「即將開放」
        badge.style.display = 'inline-block';
        badge.textContent = I18N[current.lang].badge_coming;
      } else {
        // 已開放 → 隱藏徽章（你也可以改成顯示「預購中」）
        badge.style.display = 'none';
        // badge.textContent = '預購中'; // 想顯示就把上一行改成這行
      }
    }
  });
}

  /********** 互動流程 **********/
  $('#resortChoices').addEventListener('click', e=>{
    const btn=e.target.closest('.choice'); if(!btn) return;
    if(btn.classList.contains('disabled')) return;
    $$('#resortChoices .choice').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active'); current.resort=btn.dataset.resort;
    $('#step2').classList.remove('hide'); resetAfter(1);
  });

  $('#disciplineChoices').addEventListener('click', e=>{
    const btn=e.target.closest('.choice'); if(!btn) return;
    $$('#disciplineChoices .choice').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active'); current.type=btn.dataset.type;
    $('#step3').classList.remove('hide');
    $('#details').classList.remove('hide');
    $('#addonRow').classList.remove('hide');
    updatePrice();
  });

  let oldDateValue = '';
  function onDateFocus() { oldDateValue = dateInput.value || ''; }
  function onDateBlur() {
    const newValue = dateInput.value;
    if (newValue !== oldDateValue) {
      if (newValue) {
        if (!inDateRange(newValue)) { dateWarn.style.display = 'block'; }
        else { dateWarn.style.display = 'none'; }
      } else { dateWarn.style.display = 'none'; }
      updatePrice();
    }
  }
  dateInput.addEventListener('focus', onDateFocus);
  dateInput.addEventListener('blur', onDateBlur);

  ['change','input'].forEach(ev=>{
    ['people','days','qty','level','lang'].forEach(id=>{
      const el=$('#'+id); if(el) el.addEventListener(ev, updatePrice);
    });
    addon1h.addEventListener(ev, updatePrice);
  });

  function resetAfter(step){
    if(step<=1){
      current.type=null; $('#step3').classList.add('hide');
      $$('#disciplineChoices .choice').forEach(c=>c.classList.remove('active'));
    }
    $('#addonRow').classList.add('hide'); $('#details').classList.add('hide');
    if(dateInput){ oldDateValue = ''; dateInput.value=''; dateWarn.style.display='none'; }
    if(peopleSel){ peopleSel.value='1'; }
    if(daysSel){ daysSel.value='1'; }
    if(qtySel){ qtySel.value='1'; }
    if(addon1h){ addon1h.checked=false; }
    priceBox.textContent=''; seasonNote.textContent=''; $('#agreeNotice').checked=false;
  }

  function singleDayAmount(){
    const resort=current.resort, date=dateInput?.value;
    const ppl=Number(peopleSel?.value||1);
    if(!resort || !date || !ppl || $('#details').classList.contains('hide')) return null;
    const season=isPeak(date)?'peak':'off';
    const r=priceMap[resort][season];
    const base=r.base[Math.min(ppl,4)] + (ppl>4 ? r.extra5 : 0);
    const addon=addon1h.checked ? ADDON_1H[season] : 0;
    return {amount:base+addon, season};
  }

  function updatePrice(){
    const r=singleDayAmount();
    if(!r){ priceBox.textContent=''; seasonNote.textContent=''; return; }
    const days=Number(daysSel.value||1);
    const qty =Number(qtySel.value||1);
    const peakTag = r.season==='peak' ? '（繁忙期計價）' : '';
    const total = r.amount * days * qty;

    if (isEarlyBirdNow()) {
      const discount   = EARLY_BIRD_AMOUNT * days * qty;
      const finalTotal = Math.max(0, total - discount);
      const ebNote = `（早鳥 -¥${(EARLY_BIRD_AMOUNT*days*qty).toLocaleString()}）`;
      priceBox.innerHTML =
        `<span class="price-old">${money(total)}</span>`+
        `<span class="price-new">${money(finalTotal)}</span> `+
        `${peakTag}（單日 ${money(r.amount)} × ${days} 天 × 數量 ${qty}） ${ebNote}`;
    } else {
      priceBox.textContent =
        `${money(total)}${peakTag}（單日 ${money(r.amount)} × ${days} 天 × 數量 ${qty}）`;
    }
    seasonNote.textContent = I18N[current.lang].season_off;
  }

  // 打開確認視窗
  $('#sendBtn').addEventListener('click', ()=>{
    const L = I18N[current.lang];
    if(!current.resort) return alert(L.s1t);
    if(!current.type)  return alert(L.s2t);
    if(!$('#date').value) return alert(L.date_label);
    if(!inDateRange($('#date').value)){
      const msg = (current.lang==='en') ? 'Date is outside bookable period.'
                : (current.lang==='ja') ? '予約可能期間外の日付です。'
                : '日期不在可預約期間。';
      return alert(msg);
    }
    const email = (emailInput?.value || '').trim();
    if(!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)){ return alert(L.email_label || 'Email'); }
    const pref = contactPrefSel.value;
    const cid  = (contactIdInput?.value || '').trim();
    if(pref !== 'email' && !cid){ return alert((L.contact_id_label || 'Contact ID') + '：必填'); }
    if(!$('#agreeNotice').checked){
      const agreeMsg = (current.lang==='en') ? 'Please read and agree to “Lesson Notice” first.'
                    : (current.lang==='ja') ? '『受講注意事項』に同意してください。'
                    : '請先閱讀並勾選《課程注意事項》。';
      return alert(agreeMsg);
    }

    const sd = singleDayAmount(); if(!sd) return;
    const days = Number($('#days').value);
    const qty  = Number($('#qty').value);
    const total = sd.amount * days * qty;

    const isEB = isEarlyBirdNow();
    const discount   = isEB ? EARLY_BIRD_AMOUNT * days * qty : 0;
    const finalTotal = Math.max(0, total - discount);

    const list = [
      ['Resort', $('#resortChoices .choice.active .title')?.textContent || ''],
      ['Discipline', $('#disciplineChoices .choice.active .title')?.textContent || ''],
      [L.date_label, $('#date').value],
      [L.days_label, $('#days').value],
      [L.people_label, $('#people').value],
      [L.level_label, $('#level').value],
      [L.name_label, ($('#name')?.value||'-')],
      [L.kid_age_label, ($('#kidAge')?.value||'-')],
      ['Email', email],
      [L.contact_pref_label, pref.toUpperCase() + (cid ? `：${cid}` : '')],
      [L.lang_label, $('#lang').value],
      [L.memo_label, ($('#memo').value||'-')],
      [L.qty_label, $('#qty').value],
      ['Single-day', money(sd.amount)],
      isEB
        ? ['Total', `<span class="price-old">${money(total)}</span> <span class="price-new">${money(finalTotal)}</span>（早鳥 -¥${discount.toLocaleString()}）`]
        : ['Total', money(total)]
    ];

    const box = $('#reviewList'); box.innerHTML = '';
    list.forEach(([k, v]) => {
      const row = document.createElement('div'); row.className = 'kv';
      const keyEl = document.createElement('b'); keyEl.textContent = k;
      const valEl = document.createElement('div');
      if (k === 'Total') { valEl.innerHTML = String(v); }
      else { valEl.textContent = typeof v === 'string' ? v : String(v ?? ''); }
      row.appendChild(keyEl); row.appendChild(valEl); box.appendChild(row);
    });
    $('#confirmModal').style.display = 'flex';
  });

  // 關閉確認視窗
  $('#backBtn').addEventListener('click', ()=> $('#confirmModal').style.display='none');

  // 送出到 GAS（綁在外層，只綁一次）
  $('#submitBtn').addEventListener('click', async ()=>{
    const r=singleDayAmount(); if(!r) return;
    if(!inDateRange($('#date').value)){
      const msg = (current.lang==='en') ? 'Date is outside bookable period.' :
                (current.lang==='ja') ? '予約可能期間外の日付です。' : '日期不在可預約期間。';
      return alert(msg);
    }
    const daysNum = Number($('#days').value) || 1;
    const qtyNum  = Number($('#qty').value)  || 1;
    const isEB = isEarlyBirdNow();
    const discount = isEB ? EARLY_BIRD_AMOUNT * daysNum * qtyNum : 0;
    const original_total = Number(r.amount) * daysNum * qtyNum;
    const final_total = Math.max(0, original_total - discount);

    const payload = {
      resort: current.resort, discipline: current.type, date: $('#date').value,
      days: normalizeNumber($('#days').value, 1, 10),
      people: normalizeNumber($('#people').value, 1, 5),
      level: $('#level').value, addon_1h: !!$('#addon1h').checked,
      name: ($('#name').value || '').trim(),
      kid_age: ($('#kidAge').value || '').trim(),
      email: ($('#email').value || '').trim(),
      contact_pref: $('#contactPref').value,
      contact_id: ($('#contactId').value || '').trim(),
      language: $('#lang').value,
      memo: ($('#memo').value || '').trim(),
      qty: normalizeNumber($('#qty').value, 1, 2),
      season: r.season,
      single_day_amount: Number(r.amount) || 0,
      original_total_amount: Number(original_total) || 0,
      is_early_bird: !!isEB,
      early_bird_discount: Number(discount) || 0,
      final_total_amount: Number(final_total) || 0,
      total_amount: Number(final_total) || 0,
      hp: ''
    };

console.log('POSTing to', API_URL, 'with payload:', payload);

  console.log('POSTing to', API_URL, 'with payload:', payload);

try {
  const submitBtnEl = $('#submitBtn');
  submitBtnEl.disabled = true;
  submitBtnEl.textContent =
    (current.lang === 'ja') ? '送信中...' :
    (current.lang === 'en') ? 'Submitting...' : '送出中...';

  const controller = new AbortController();
  const timer = setTimeout(() => controller.abort(), 20000);

  const resp = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain; charset=utf-8' }, // 直打 GAS 時改成 application/json
    body: JSON.stringify(payload),
    signal: controller.signal
  });
  clearTimeout(timer);

  console.log('HTTP status:', resp.status, resp.statusText);

  // 拿原始字串，再嘗試轉 JSON
  const raw = await resp.text();
  let data;
  try {
    data = JSON.parse(raw);
  } catch {
    data = { status: 'error', message: raw || 'Invalid JSON from server' };
  }

  console.log('API raw:', raw);
  console.log('API response:', data);
  console.log('API response.status:', data.status);

  if (data.status !== 'success') {
    throw new Error(data.message || `Server error (HTTP ${resp.status})`);
  }

  // 成功
  alert(I18N[current.lang].success);
  $('#confirmModal').style.display = 'none';
  location.reload();

} catch (e) {
  console.error('Submit failed:', e);
  alert(
    (current.lang==='en' ? 'Failed to submit. Please try again later.'
      : (current.lang==='ja' ? '送信に失敗しました。しばらくしてからもう一度お試しください。' : '送出失敗，請稍後再試。'
    )) + '\n' + String(e)
  );
} finally {
  const submitBtnEl = $('#submitBtn');
  if (submitBtnEl) {
    submitBtnEl.disabled = false;
    submitBtnEl.textContent = I18N[current.lang].submit || '送出';
  }
}
  });

  // 初始化
  (function init(){
    setLang('zh-Hant');
    const dateEl=$('#date'); dateEl.min=DATE_MIN; dateEl.max=DATE_MAX;
    applyResortAvailability();
    applyContactPlaceholder();
  })();
</script>
</body>
</html>
